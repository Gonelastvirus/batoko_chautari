{% extends "base.html" %}

{% block title %}Add Review for {{ spot.name }} - Batoko Chautari{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Back Button -->
            <div class="mb-4">
                <a href="{{ url_for('spot_detail', id=spot.id) }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to {{ spot.name }}
                </a>
            </div>

            <!-- Spot Info Card -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="row g-0">
                    <div class="col-md-4">
                        {% set cover_photo = spot.get_approved_photos() | selectattr('is_cover_photo') | first %}
                        {% if cover_photo %}
                            <img src="{{ url_for('uploaded_file', filename=cover_photo.filename) }}" 
                                 class="img-fluid rounded-start h-100" style="object-fit: cover;" 
                                 alt="{{ spot.name }}">
                        {% else %}
                            <img src="https://pixabay.com/get/g22505a92c3abfad8230eb129dd903f5efb3a42fbe0b11d37407451176f59747f33b5f5d6f846e14b9992d3cafd2932298823d609ed13f338c839a2da716e4553_1280.jpg" 
                                 class="img-fluid rounded-start h-100" style="object-fit: cover;" 
                                 alt="{{ spot.name }}">
                        {% endif %}
                    </div>
                    <div class="col-md-8">
                        <div class="card-body">
                            <h5 class="card-title text-forest">{{ spot.name }}</h5>
                            <p class="card-text text-muted">
                                <i class="fas fa-map-marker-alt me-1"></i>{{ spot.district }}
                                <span class="badge bg-nature ms-2">{{ spot.spot_type.title() }}</span>
                            </p>
                            {% if spot.description %}
                                <p class="card-text">{{ spot.description[:150] }}{% if spot.description|length > 150 %}...{% endif %}</p>
                            {% endif %}
                            {% set rating = spot.get_average_rating() %}
                            {% if rating > 0 %}
                                <div class="text-warning">
                                    {{ rating | round(1) }} ★ ({{ spot.reviews|length }} reviews)
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Review Form -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-forest text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-star me-2"></i>Share Your Experience
                    </h4>
                </div>
                <div class="card-body">
                    <form method="POST" enctype="multipart/form-data" id="reviewForm">
                        {{ form.hidden_tag() }}
                        
                        <!-- Rating -->
                        <div class="mb-4">
                            {{ form.rating.label(class="form-label fw-bold") }}
                            <div class="rating-input d-flex align-items-center gap-2">
                                {% for value, label in form.rating.choices %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="rating" 
                                               id="rating{{ value }}" value="{{ value }}" 
                                               {% if form.rating.data == value %}checked{% endif %}>
                                        <label class="form-check-label" for="rating{{ value }}">
                                            <span class="rating-stars text-warning">{{ '★' * value }}</span>
                                            <small class="text-muted d-block">{{ label.split(' - ')[1] }}</small>
                                        </label>
                                    </div>
                                {% endfor %}
                            </div>
                            {% if form.rating.errors %}
                                <div class="text-danger small mt-1">{{ form.rating.errors[0] }}</div>
                            {% endif %}
                        </div>

                        <!-- Visit Date -->
                        <div class="mb-4">
                            {{ form.visit_date.label(class="form-label fw-bold") }}
                            {{ form.visit_date(class="form-control") }}
                            {% if form.visit_date.errors %}
                                <div class="text-danger small mt-1">{{ form.visit_date.errors[0] }}</div>
                            {% endif %}
                        </div>

                        <!-- Comment -->
                        <div class="mb-4">
                            {{ form.comment.label(class="form-label fw-bold") }}
                            {{ form.comment(class="form-control", rows="5", placeholder="Share your experience, what you loved, tips for other travelers...") }}
                            <div class="form-text">Optional but encouraged. Share what made this place special!</div>
                            {% if form.comment.errors %}
                                <div class="text-danger small mt-1">{{ form.comment.errors[0] }}</div>
                            {% endif %}
                        </div>

                        <!-- Photo Upload -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Upload Photos (Minimum 2 required)</label>
                            <div class="upload-area border-2 border-dashed border-nature rounded p-4 text-center" id="uploadArea">
                                <div class="upload-placeholder">
                                    <i class="fas fa-cloud-upload-alt text-nature fs-1 mb-3"></i>
                                    <h5 class="text-nature">Drag and drop photos here</h5>
                                    <p class="text-muted mb-3">or click to browse files</p>
                                    <input type="file" class="form-control d-none" id="photoInput" 
                                           name="photos" multiple accept="image/*">
                                    <button type="button" class="btn btn-outline-nature" onclick="document.getElementById('photoInput').click()">
                                        <i class="fas fa-plus me-2"></i>Choose Photos
                                    </button>
                                </div>
                            </div>
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                Upload at least 2 photos. JPG, PNG formats supported. Max 16MB per file.
                            </div>
                            <div id="photoPreview" class="mt-3"></div>
                            {% if form.photos.errors %}
                                <div class="text-danger small mt-1">{{ form.photos.errors[0] }}</div>
                            {% endif %}
                        </div>

                        <!-- Important Note -->
                        <div class="alert alert-info">
                            <h6 class="alert-heading">
                                <i class="fas fa-lightbulb me-2"></i>Review Guidelines
                            </h6>
                            <ul class="mb-0">
                                <li>Be honest and helpful in your review</li>
                                <li>Upload clear, high-quality photos</li>
                                <li>Photos will be reviewed by our team before being published</li>
                                <li>You'll earn points for contributing to the community!</li>
                            </ul>
                        </div>

                        <!-- Submit Button -->
                        <div class="d-grid gap-2">
                            {{ form.submit(class="btn btn-nature btn-lg", id="submitBtn") }}
                            <a href="{{ url_for('spot_detail', id=spot.id) }}" class="btn btn-outline-secondary">
                                Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const photoInput = document.getElementById('photoInput');
    const uploadArea = document.getElementById('uploadArea');
    const photoPreview = document.getElementById('photoPreview');
    const submitBtn = document.getElementById('submitBtn');
    const form = document.getElementById('reviewForm');
    
    let selectedFiles = [];

    // Drag and drop functionality
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('border-success', 'bg-light');
    });

    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('border-success', 'bg-light');
    });

    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('border-success', 'bg-light');
        
        const files = Array.from(e.dataTransfer.files);
        handleFiles(files);
    });

    // File input change
    photoInput.addEventListener('change', function(e) {
        const files = Array.from(e.target.files);
        handleFiles(files);
    });

    function handleFiles(files) {
        // Filter only image files
        const imageFiles = files.filter(file => file.type.startsWith('image/'));
        
        if (imageFiles.length === 0) {
            alert('Please select only image files.');
            return;
        }

        // Add new files to selected files
        selectedFiles = [...selectedFiles, ...imageFiles];
        
        // Update file input
        updateFileInput();
        
        // Show preview
        showPreview();
        
        // Update validation
        updateValidation();
    }

    function updateFileInput() {
        const dataTransfer = new DataTransfer();
        selectedFiles.forEach(file => dataTransfer.items.add(file));
        photoInput.files = dataTransfer.files;
    }

    function showPreview() {
        photoPreview.innerHTML = '';
        
        if (selectedFiles.length === 0) {
            return;
        }

        const previewContainer = document.createElement('div');
        previewContainer.className = 'row g-3';
        
        selectedFiles.forEach((file, index) => {
            const col = document.createElement('div');
            col.className = 'col-md-3 col-6';
            
            const card = document.createElement('div');
            card.className = 'card border-0 shadow-sm position-relative';
            
            const img = document.createElement('img');
            img.className = 'card-img-top';
            img.style.height = '150px';
            img.style.objectFit = 'cover';
            img.src = URL.createObjectURL(file);
            
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn btn-danger btn-sm position-absolute top-0 end-0 m-2 rounded-circle';
            removeBtn.innerHTML = '<i class="fas fa-times"></i>';
            removeBtn.onclick = () => removeFile(index);
            
            const cardBody = document.createElement('div');
            cardBody.className = 'card-body p-2';
            cardBody.innerHTML = `<small class="text-muted">${file.name}</small>`;
            
            card.appendChild(img);
            card.appendChild(removeBtn);
            card.appendChild(cardBody);
            col.appendChild(card);
            previewContainer.appendChild(col);
        });
        
        photoPreview.appendChild(previewContainer);
    }

    function removeFile(index) {
        selectedFiles.splice(index, 1);
        updateFileInput();
        showPreview();
        updateValidation();
    }

    function updateValidation() {
        const minPhotos = 2;
        const isValid = selectedFiles.length >= minPhotos;
        
        // Update submit button
        if (isValid) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-check me-2"></i>Submit Review';
        } else {
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<i class="fas fa-camera me-2"></i>Need ${minPhotos - selectedFiles.length} more photo${(minPhotos - selectedFiles.length) > 1 ? 's' : ''}`;
        }
        
        // Update upload area message
        if (selectedFiles.length > 0) {
            uploadArea.querySelector('.upload-placeholder').innerHTML = `
                <i class="fas fa-check-circle text-success fs-1 mb-3"></i>
                <h5 class="text-success">${selectedFiles.length} photo${selectedFiles.length > 1 ? 's' : ''} selected</h5>
                <p class="text-muted mb-3">You can add more photos or continue</p>
                <button type="button" class="btn btn-outline-nature" onclick="document.getElementById('photoInput').click()">
                    <i class="fas fa-plus me-2"></i>Add More Photos
                </button>
            `;
        }
    }

    // Form submission
    form.addEventListener('submit', function(e) {
        if (selectedFiles.length < 2) {
            e.preventDefault();
            alert('Please upload at least 2 photos with your review.');
            return false;
        }
        
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Submitting...';
    });

    // Set today's date as default for visit date
    const visitDateInput = document.querySelector('input[name="visit_date"]');
    if (!visitDateInput.value) {
        const today = new Date().toISOString().split('T')[0];
        visitDateInput.value = today;
    }

    // Rating selection visual feedback
    document.querySelectorAll('input[name="rating"]').forEach(radio => {
        radio.addEventListener('change', function() {
            document.querySelectorAll('.rating-stars').forEach(stars => {
                stars.style.opacity = '0.3';
            });
            
            const selectedLabel = this.nextElementSibling;
            const selectedStars = selectedLabel.querySelector('.rating-stars');
            selectedStars.style.opacity = '1';
            selectedStars.style.transform = 'scale(1.1)';
            
            setTimeout(() => {
                selectedStars.style.transform = 'scale(1)';
                document.querySelectorAll('.rating-stars').forEach(stars => {
                    stars.style.opacity = '1';
                });
            }, 200);
        });
    });

    // Initial validation
    updateValidation();
});
</script>

<style>
.upload-area {
    transition: all 0.3s ease;
    cursor: pointer;
}

.upload-area:hover {
    border-color: var(--bs-success) !important;
    background-color: rgba(var(--bs-success-rgb), 0.1);
}

.rating-input .form-check {
    flex: 1;
    text-align: center;
    border: 2px solid transparent;
    border-radius: 8px;
    padding: 10px;
    transition: all 0.3s ease;
}

.rating-input .form-check:hover {
    border-color: #28a745;
    background-color: rgba(40, 167, 69, 0.1);
}

.rating-input .form-check-input:checked + .form-check-label {
    color: #28a745;
}

.rating-stars {
    font-size: 1.2rem;
    transition: all 0.3s ease;
}
</style>
{% endblock %}
